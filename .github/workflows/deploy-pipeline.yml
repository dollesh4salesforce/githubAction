name: Deploy Pipeline (Dev → UAT → Prod)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to deploy"
        required: false
        default: "main"
      runDev:
        description: "Include Dev deployment?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      runUat:
        description: "Include UAT deployment?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      runProd:
        description: "Include Prod deployment?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  dev:
    if: ${{ inputs.runDev == 'true' }}
    name: Deploy to Dev
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Setup Salesforce CLI (sf)
        uses: salesforcecli/github-action@v1
        with:
          install: "sf"

      - name: Authenticate Dev via JWT
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
          SF_DEV_USERNAME: ${{ secrets.SF_DEV_USERNAME }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
        run: |
          echo "$SF_JWT_KEY" > server.key
          sf org login jwt --username "$SF_DEV_USERNAME" --jwt-key-file server.key --client-id "$SF_CLIENT_ID" --instance-url "$SF_LOGIN_URL" --alias DevOrg --set-default
          rm -f server.key
          sf org display --target-org DevOrg

      - name: Lint
        run: npm run lint

      - name: Unit tests (LWC Jest)
        run: npm run test:unit --if-present

      - name: Deploy to Dev
        run: sf project deploy start --target-org DevOrg --source-dir force-app --ignore-conflicts --wait 33

  uat:
    if: ${{ inputs.runUat == 'true' }}
    name: Deploy to UAT
    runs-on: ubuntu-latest
    needs: [dev]
    environment: uat
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Setup Salesforce CLI (sf)
        uses: salesforcecli/github-action@v1
        with:
          install: "sf"

      - name: Authenticate UAT via JWT
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
          SF_UAT_USERNAME: ${{ secrets.SF_UAT_USERNAME }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
        run: |
          echo "$SF_JWT_KEY" > server.key
          sf org login jwt --username "$SF_UAT_USERNAME" --jwt-key-file server.key --client-id "$SF_CLIENT_ID" --instance-url "$SF_LOGIN_URL" --alias UATOrg --set-default
          rm -f server.key
          sf org display --target-org UATOrg

      - name: Validate to UAT (check-only + tests)
        run: sf project deploy validate --target-org UATOrg --source-dir force-app --test-level RunLocalTests --wait 33

      - name: Deploy to UAT
        if: success()
        run: sf project deploy start --target-org UATOrg --source-dir force-app --wait 33

  prod:
    if: ${{ inputs.runProd == 'true' }}
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [uat]
    environment:
      name: production
      url: https://login.salesforce.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Setup Salesforce CLI (sf)
        uses: salesforcecli/github-action@v1
        with:
          install: "sf"

      - name: Authenticate Prod via JWT
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
          SF_PROD_USERNAME: ${{ secrets.SF_PROD_USERNAME }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
        run: |
          echo "$SF_JWT_KEY" > server.key
          sf org login jwt --username "$SF_PROD_USERNAME" --jwt-key-file server.key --client-id "$SF_CLIENT_ID" --instance-url "$SF_LOGIN_URL" --alias ProdOrg --set-default
          rm -f server.key
          sf org display --target-org ProdOrg

      - name: Validate to Prod (check-only + tests)
        run: sf project deploy validate --target-org ProdOrg --source-dir force-app --test-level RunLocalTests --wait 60

      - name: Deploy to Prod
        if: success()
        run: sf project deploy start --target-org ProdOrg --source-dir force-app --wait 60
